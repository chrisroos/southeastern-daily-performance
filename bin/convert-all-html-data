#!/usr/bin/env ruby

FORMATS = ['full', 'overview']

def print_usage_instruction_and_exit
  puts "Usage: #{File.basename(__FILE__)} [#{FORMATS.join('|')}]"
  exit 1
end

print_usage_instruction_and_exit unless format = ARGV[0]
print_usage_instruction_and_exit unless FORMATS.include?(format)
  
ROOT          = File.expand_path('../../', __FILE__)
HTML_DATA_DIR = File.join(ROOT, 'data', 'html')
CSV_DATA_DIR  = File.join(ROOT, 'data', 'csv')

LIB_DIR       = File.join(ROOT, 'lib')
CONVERTOR     = File.join(ROOT, 'bin', 'sedpr-to-csv')
OPTIONAL_ARGS = (format == 'overview') ? 'overview' : ''

Dir[File.join(HTML_DATA_DIR, '*.html')].each do |file|
  p file
  
  html_filename = File.basename(file)
  csv_filename  = html_filename.sub(/\.html/, '.csv')
  csv_filename  = csv_filename.sub(/\.csv/, '.overview.csv') if format == 'overview'
  
  cmd = "ruby -I#{LIB_DIR} #{CONVERTOR} #{file} #{OPTIONAL_ARGS} > #{File.join(CSV_DATA_DIR, csv_filename)}"
  `#{cmd}`
end